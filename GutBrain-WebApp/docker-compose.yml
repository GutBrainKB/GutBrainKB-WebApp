version: "3.9"

services:
  web:
    build:
      context: ./backend
      dockerfile: Dockerfile.dockerfile
    container_name: gutbrain-web
    environment:
      - PYTHONUNBUFFERED=1
      - DJANGO_ALLOWED_HOSTS=*
      # If you're on Django 4+, add this (adjust host/port if needed):
      # - CSRF_TRUSTED_ORIGINS=http://exa.dei.unipd.it:8088
      - GRAPHDB_ENDPOINT_URL=http://examode.dei.unipd.it:7200/repositories/gutbrainkb
      - GRAPHDB_STATEMENTS_URL=http://examode.dei.unipd.it:7200/repositories/gutbrainkb/statements
      - GRAPHDB_USERNAME=gutbrainkb
      - GRAPHDB_PASSWORD=gutbrainkb25
    command: sh -c "python manage.py migrate && python manage.py runserver 0.0.0.0:8000"
    volumes:
      - ./backend:/app
    expose:
      - "8000"               # only inside the Docker network
    restart: unless-stopped

  frontend:
    image: nginx:alpine
    container_name: gutbrain-frontend
    volumes:
      - ./frontend/dist:/usr/share/nginx/html:ro
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    ports:
      - "8088:80"
    depends_on:
      - web
    restart: unless-stopped
